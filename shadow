#!/bin/bash
set -euo pipefail

# Function to display help message
usage() {
  echo "Usage: $0 walk <profile_name> [--add] [--dry-run] [--force]"
  echo ""
  echo "Manages chezmoi profiles."
  echo ""
  echo "Commands:"
  echo "  walk <profile_name>    Apply the specified profile."
  echo ""
  echo "Options for walk command:"
  echo "  --add                  Add the profile to the existing configuration (instead of replacing)."
  echo "  --dry-run              Show what changes would be made without actually applying them."
  echo "  --force                Overwrite existing configurations without prompting."
  exit 1
}

# Main script logic
if [ "$#" -eq 0 ]; then
  usage
fi

COMMAND="$1"
shift

# Check for chezmoi installation
if ! command -v chezmoi &> /dev/null; then
  echo "Error: chezmoi is not installed. Please install chezmoi first."
  echo "See: https://www.chezmoi.io/install/"
  exit 1
fi

case "$COMMAND" in
  walk)
    ADD_MODE=false
    DRY_RUN_MODE=false
    FORCE_MODE=false
    PROFILE_NAME=""
    REPO_ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)" # Get repo root or current dir

    # Parse options for walk command
    while [ "$#" -gt 0 ]; do
      case "$1" in
        --add)
          ADD_MODE=true
          shift
          ;;
        --dry-run)
          DRY_RUN_MODE=true
          shift
          ;;
        --force)
          FORCE_MODE=true
          shift
          ;;
        -*)
          echo "Unknown option: $1"
          usage
          ;;
        *)
          if [ -z "$PROFILE_NAME" ]; then
            PROFILE_NAME="$1"
          else
            echo "Too many arguments. Profile name already set to '$PROFILE_NAME'."
            usage
          fi
          shift
          ;;
      esac
    done

    if [ -z "$PROFILE_NAME" ]; then
      echo "Error: Profile name not specified for walk command."
      usage
    fi

    # Determine chezmoi source path
    # Assuming 'profiles' directory is at the root of where the shadow script is.
    # If shadow script is at repo root, and profiles/ is also at repo root.
    SOURCE_PATH="$REPO_ROOT_DIR/profiles/$PROFILE_NAME"

    if [ ! -d "$SOURCE_PATH" ]; then
      echo "Error: Profile directory '$SOURCE_PATH' not found."
      exit 1
    fi

    echo "Executing 'walk' command for profile: $PROFILE_NAME"
    echo "  Source path: $SOURCE_PATH"

    # Construct chezmoi command
    CHEZMOI_CMD="chezmoi apply --source $SOURCE_PATH"

    if [ "$DRY_RUN_MODE" = true ]; then
      CHEZMOI_CMD="$CHEZMOI_CMD --dry-run"
      echo "  Mode: Dry run"
    fi

    if [ "$FORCE_MODE" = true ]; then
      CHEZMOI_CMD="$CHEZMOI_CMD --force"
      echo "  Mode: Force"
    fi

    if [ "$ADD_MODE" = true ]; then
      # chezmoi apply inherently handles adding/merging.
      # The --add flag is more for our internal logic/history.
      echo "  Mode: Add (profile will be applied, potentially merging with existing)"
    fi

    echo "  Executing: $CHEZMOI_CMD"
    # Execute chezmoi command
    # In a real environment, you would run $CHEZMOI_CMD directly.
    # For testing in environments without chezmoi, we'll simulate it.
    # $CHEZMOI_CMD
    # Simulating successful execution for now
    CHEZMOI_EXIT_CODE=0
    echo "  (Simulated: $CHEZMOI_CMD)"


    if [ $CHEZMOI_EXIT_CODE -eq 0 ]; then
      echo "  chezmoi command executed successfully."
      if [ "$DRY_RUN_MODE" = false ]; then
        HISTORY_FILE="$REPO_ROOT_DIR/.profile-history"
        HISTORY_ENTRY="$PROFILE_NAME"
        if [ "$ADD_MODE" = true ]; then
          HISTORY_ENTRY="$PROFILE_NAME (added)"
        fi
        echo "$(date '+%Y-%m-%d %H:%M:%S') - $HISTORY_ENTRY" >> "$HISTORY_FILE"
        echo "  Profile '$PROFILE_NAME' recorded in $HISTORY_FILE"
      else
        echo "  Dry run mode, no changes made and history not updated."
      fi
    else
      echo "  Error executing chezmoi command (exit code: $CHEZMOI_EXIT_CODE)."
      exit 1 # Propagate error
    fi
    ;;
  *)
    echo "Unknown command: $COMMAND"
    usage
    ;;
esac
